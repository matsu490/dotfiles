% SD, firing rate time course of bined raster

clear all
close all
fclose('all');

% *********************************
% *** Parameters for simulation ***
% *********************************
strEnv = {'stim100' 'addstdp' 'mltstdp' 'stim050' 'stim060' 'stim070' 'stim080' 'stim090'};
strData =  {'50[Hz]' '100[Hz]' '200[Hz]' '0.3[-]' '0.5[-]' '0.7[-]'};
strTest =  {'1,000[msec](same)' '2,000[msec](same)' '4,000[msec](same)'...
			'1,000[msec](diff)' '2,000[msec](diff)' '4,000[msec](diff)'...
			'wo-learning' 'wo-input mod' ' wo-learning & input mod'};
strCmp = {'02' '04' '06' '08' '10' '12' '14' '16' '18' '20'};
strTrl = {'01' '02' '03' '04' '05' '06' '07' '08' '09' '10'};

pltEnv  = 1:1;
pltData = [6];
pltTest = [1];

global STIM_TIME ID_G1 ID_G2 ID_OTHER NUM_EXC
STIM_TIME = 500;
ID_G1 = 1:100;
ID_G2 = 101:200;
ID_OTHER = 201:400;
NUM_EXC = 400;

tbin = 25; % [ms]: default=25ms corresponds 40Hz(Gamma range)
trange = [0 110000]; % range for total PCA
tstarts = [0 100000 105000]; % range for specific period
tdurs = [100000 5000 500];
tends = tstarts + tdurs;

% ********************
% *** Main routine ***
% ********************

dirPrnt = sprintf('../DataBase');
dirPrntSeq = sprintf('..');

for i = pltEnv
	dirEnv = sprintf('%s/%s',dirPrnt,strEnv{i});
	dirEnvSeq = sprintf('%s/mod-code-longstim02-%s',dirPrntSeq,strEnv{i});

	for j = pltData
		dirData = sprintf('%s/data%d',dirEnv,j);
		dirDataSeq = sprintf('%s/data%d',dirEnvSeq,j);

		for k = pltTest
			dirTest = sprintf('%s/test0%d',dirData,k);
			dirTestSeq = sprintf('%s/data-test0%d',dirDataSeq,k);
			load_path = sprintf('%s/espk',dirTestSeq);
			espk0 = load(load_path);

			ts = trange(1):tbin:trange(2);
			ns = zeros(NUM_EXC,length(ts)-1);
			for l=1:NUM_EXC
				neuron = l - 1;
				tmpi = find(espk0(:,2)==neuron);
				tmpdata = espk0(tmpi,1);
				clear tmpns bin
				[tmpns,bin] = histc(tmpdata,ts);
				ns(l,:) = tmpns(1:end-1)';
			end

			tmpID = [ID_G2 ID_OTHER];
			ID = {ID_G1;tmpID};
			for n=1:length(ID)
				%Rate(n,:) = sum(ns(ID{n,1},:),1)/(length(ID{n,1})*tbin*0.001);
				Rate(n,:) = mean(ns(ID{n,1},:),1)/(tbin*0.001);
				SD(n,:) = std(ns(ID{n,1},:),1)/(tbin*0.001);
			end
			CV = SD./Rate;
			CV(isnan(CV))=0;

			[idSAEA] = f_idgen(ns,tbin,trange(2),j,k);

			if sum(j==[1 2 3])
				pro = {'go' 'r*'};
				itr = 1:2;
			elseif sum(j==[4 5 6])
				pro = {'go' 'bo' 'r*'};
				itr = 1:3;
			end

			sWindow = sprintf('%s %s %s',strEnv{1,i},strData{1,j},strTest{1,k});
			figure(10*j+1)
			set(gcf,'Name',sWindow)
			figure(10*j+2)
			set(gcf,'Name',sWindow)
			for m=itr
				figure(10*j+1)
				ax(1) = subplot(2,2,1);
				title('Before learning')
				xlabel('Spike rate in a bin [Hz]')
				ylabel({'G1';'SD of 400 dim vector [Hz]'})
				plot(Rate(1,id{1,m}),SD(1,id{1,m}),pro{1,m});hold on
				ax(2) = subplot(2,2,2);
				title('After learning')
				plot(Rate(1,id{2,m}),SD(1,id{2,m}),pro{1,m});hold on
				ax(3) = subplot(2,2,3);
				ylabel({'G2 + Other';'SD [Hz]'})
				plot(Rate(2,id{1,m}),SD(2,id{1,m}),pro{1,m});hold on
				ax(4) = subplot(2,2,4);
				plot(Rate(2,id{2,m}),SD(2,id{2,m}),pro{1,m});hold on

				figure(10*j+2)
				subplot(2,2,1);
				title('SD [Hz]')
				xlabel('Time bin')
				ylabel('G1')
				plot(id{1,m},SD(1,id{1,m}),pro{1,m});hold on
				plot(id{2,m},SD(1,id{2,m}),pro{1,m});hold on
				subplot(2,2,2);
				title('Rate [Hz]')
				xlabel('Time bin')
				plot(id{1,m},Rate(1,id{1,m}),pro{1,m});hold on
				plot(id{2,m},Rate(1,id{2,m}),pro{1,m});hold on
				subplot(2,2,3);
				ylabel('G2 + Other')
				plot(id{1,m},SD(2,id{1,m}),pro{1,m});hold on
				plot(id{2,m},SD(2,id{2,m}),pro{1,m});hold on
				subplot(2,2,4);
				plot(id{1,m},Rate(2,id{1,m}),pro{1,m});hold on
				plot(id{2,m},Rate(2,id{2,m}),pro{1,m});hold on
			end
			%linkaxes(ax,'xy')

%			figure
%			sWindow = sprintf('%s %s %s',strEnv{1,i},strData{1,j},strTest{1,k});
%			set(gcf,'Name',sWindow)
%			for m=itr
%				subplot(3,2,1)
%				plot(Rate(1,id{1,m}),SD(1,id{1,m}),pro{1,m});hold on
%				title('Before learning')
%				xlabel('Spike rate in a bin [Hz]')
%				ylabel('SD of 400 dim vector [Hz]')
%				subplot(3,2,2)
%				plot(Rate(1,id{2,m}),SD(1,id{2,m}),pro{1,m});hold on
%				title('After learning')
%				subplot(3,1,2)
%				plot(id{1,m},Rate(1,id{1,m}),pro{1,m});hold on
%				plot(id{2,m},Rate(1,id{2,m}),pro{1,m});hold on
%				subplot(3,1,3)
%				plot(id{1,m},SD(1,id{1,m}),pro{1,m});hold on
%				plot(id{2,m},SD(1,id{2,m}),pro{1,m});hold on
%			end

			fprintf('For loop have finished until test0%d\n',k);
		end %for k : data-test

		fprintf('For loop have finished until data%d\n',j);
	end %for j : data

	fprintf('For loop have finished until simu env%d\n',i);
end	%for i : simulation environment
